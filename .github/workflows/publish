name: Build Unity Game

on:
    push:
        branches: ["main"]
    workflow_dispatch:

permissions:
    contents: write

env:
    UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
    UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
    UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    UNITY_VERSION: 6000.3.3f1

jobs:
    buildWindows:
        name: Build for Windows
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Restore Cache
              uses: actions/cache@v4
              with:
                  path: Library
                  key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
                  restore-keys: |
                      Library-

            - name: Build Windows
              uses: game-ci/unity-builder@v4
              with:
                  targetPlatform: StandaloneWindows64
                  unityVersion: ${{ env.UNITY_VERSION }}

            - name: Upload Windows Build
              uses: actions/upload-artifact@v4
              with:
                  name: Build-Windows
                  path: build/StandaloneWindows64

    buildWebGL:
        name: Build for WebGL
        runs-on: ubuntu-latest
        steps:
            - name: Free Disk Space
              uses: jlumbroso/free-disk-space@main
              with:
                  tool-cache: false
                  android: true
                  dotnet: true
                  haskell: true
                  large-packages: true
                  docker-images: true
                  swap-storage: true

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  lfs: true

            - name: Restore Cache
              uses: actions/cache@v4
              with:
                  path: Library
                  key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
                  restore-keys: |
                      Library-

            - name: Build WebGL
              uses: game-ci/unity-builder@v4
              with:
                  targetPlatform: WebGL
                  unityVersion: ${{ env.UNITY_VERSION }}

            - name: Upload WebGL Build
              uses: actions/upload-artifact@v4
              with:
                  name: Build-WebGL
                  path: build/WebGL/WebGL

            - name: Deploy to GitHub Pages
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  folder: build/WebGL/WebGL
                  branch: gh-pages
                  cname: ggj.tranvlnh.id.vn

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [buildWindows, buildWebGL]
        steps:
            - name: Download Windows Build
              uses: actions/download-artifact@v4
              with:
                  name: Build-Windows
                  path: Build-Windows

            - name: Download WebGL Build
              uses: actions/download-artifact@v4
              with:
                  name: Build-WebGL
                  path: Build-WebGL

            - name: Zip Builds
              run: |
                  zip -r Build-Windows.zip Build-Windows
                  zip -r Build-WebGL.zip Build-WebGL

            - name: Get current date
              id: date
              run: echo "date=$(date +'%Y-%m-%d-%H%M%S')" >> $GITHUB_OUTPUT

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: build-${{ steps.date.outputs.date }}
                  name: Build ${{ steps.date.outputs.date }}
                  body: |
                      Automated build from commit ${{ github.sha }}
                  files: |
                      Build-Windows.zip
                      Build-WebGL.zip
